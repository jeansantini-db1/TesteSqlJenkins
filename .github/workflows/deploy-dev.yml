name: After Merge

on:
  push:
    branches:
      - dev   # só roda quando há merge na branch dev

jobs:
  process-sql:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repositório
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_PAT }}

      - name: Extrair infos do commit/PR
        run: |
          echo "DATE=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_ENV
          echo "AUTHOR=${{ github.actor }}" >> $GITHUB_ENV
          echo "BRANCH=${GITHUB_REF#refs/heads/}" >> $GITHUB_ENV

      - name: Gerar log de instruções
        run: |
          mkdir -p logs
          echo "${DATE} | BRANCH=${BRANCH} | AUTHOR=${AUTHOR} | FILES:" > logs/${DATE}.txt
          git diff-tree --no-commit-id --name-only -r ${{ github.sha }} >> logs/${DATE}.txt

      - name: Commitar log
        run: |
          git config user.name "Org Bot"
          git config user.email "bot@org.com"
          git add logs/
          git commit -m "Registro pós-merge $DATE" || echo "Nada para commit"
          git push
