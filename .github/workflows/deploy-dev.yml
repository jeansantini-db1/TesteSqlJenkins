name: Valida√ß√£o SQL e T√≠tulo do PR

on:
  pull_request:
    branches: [ dev ]
    types: [opened, edited, synchronize, reopened]

jobs:
  validar-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Validar t√≠tulo do PR
        uses: actions/github-script@v6
        with:
          script: |
            const title = context.payload.pull_request.title;
            const pattern = /^\[[a-zA-Z]{1,7}-\d{1,7}\] .+$/;
            if (!pattern.test(title)) {
              core.setFailed(`‚ùå T√≠tulo inv√°lido: "${title}". Deve seguir o padr√£o: [PREFIXO-123] Descri√ß√£o.`);
            }

      - name: üîç Verificar arquivos .sql modificados
        id: sqlval
        run: |
          echo "üö® Validando arquivos SQL..."

          modified_sql=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep '\.sql$' || true)

          if [ -z "$modified_sql" ]; then
            echo "‚úÖ Nenhum script SQL alterado."
            exit 0
          fi

          has_error=0

          for file in $modified_sql; do
            echo "üîé Validando $file"
            
            # Normaliza para letras min√∫sculas (evita false negative)
            lower_content=$(tr '[:upper:]' '[:lower:]' < "$file")
            
            # Tipos que exigem OR REPLACE
            tipos=("package" "procedure" "function" "trigger" "view" "type")

            for tipo in "${tipos[@]}"; do
              if echo "$lower_content" | grep -q "create[[:space:]]\\+$tipo"; then
                if ! echo "$lower_content" | grep -q "create[[:space:]]\\+or[[:space:]]\\+replace[[:space:]]\\+$tipo"; then
                  echo "‚ùå $file cont√©m CREATE $tipo mas est√° sem OR REPLACE"
                  has_error=1
                fi
              fi
            done

            # DELETE sem WHERE
            if echo "$lower_content" | grep -qE 'delete\s+from\s+\w+\s*;?' && ! echo "$lower_content" | grep -q 'where'; then
              echo "‚ùå $file cont√©m DELETE sem WHERE"
              has_error=1
            fi

            # DROP alerta (n√£o falha)
            if echo "$lower_content" | grep -q 'drop '; then
              echo "‚ö†Ô∏è Aten√ß√£o: DROP encontrado em $file"
            fi

            # Encoding UTF-8
            if ! file -bi "$file" | grep -q 'utf-8'; then
              echo "‚ùå $file n√£o est√° em UTF-8"
              has_error=1
            fi
          done

          exit $has_error
