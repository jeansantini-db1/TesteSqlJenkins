name: ValidaÃ§Ã£o SQL e TÃ­tulo do PR

on:
  pull_request:
    branches: [ dev ]
    types: [opened, edited, synchronize, reopened]

jobs:
  validar-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Validar tÃ­tulo do PR (DEV-xxx)
        uses: actions/github-script@v6
        with:
          script: |
            const title = context.payload.pull_request.title;
            const pattern = /^\[[a-zA-Z]{1,7}-\d{1,7}\] .+$/;
            if (!pattern.test(title)) {
              core.setFailed(`âŒ TÃ­tulo invÃ¡lido: "${title}". Deve seguir o padrÃ£o: [PREFIXO-123] DescriÃ§Ã£o.`);
            }

      - name: ğŸ§ª Validar tÃ­tulo do PR
        uses: amannn/action-pull-request-title@v4
        with:
          title: ${{ github.event.pull_request.title }}
          regex: '^\[[a-zA-Z]{1,7}\-\d{1,7}\] .+$'

      - name: ğŸ” Verificar arquivos .sql modificados
        id: sqlval
        run: |
          echo "ğŸš¨ Validando arquivos SQL..."

          modified_sql=$(git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep '\.sql$' || true)

          if [ -z "$modified_sql" ]; then
            echo "âœ… Nenhum script SQL alterado."
            exit 0
          fi

          has_error=0

          for file in $modified_sql; do
            echo "ğŸ” Validando $file"
            
            # Normaliza para letras minÃºsculas (evita false negative)
            lower_content=$(tr '[:upper:]' '[:lower:]' < "$file")
            
            # Tipos que exigem OR REPLACE
            tipos=("package" "procedure" "function" "trigger" "view" "type")

            for tipo in "${tipos[@]}"; do
              if echo "$lower_content" | grep -q "create[[:space:]]\\+$tipo"; then
                if ! echo "$lower_content" | grep -q "create[[:space:]]\\+or[[:space:]]\\+replace[[:space:]]\\+$tipo"; then
                  echo "âŒ $file contÃ©m CREATE $tipo mas estÃ¡ sem OR REPLACE"
                  has_error=1
                fi
              fi
            done

            # DELETE sem WHERE
            if echo "$lower_content" | grep -qE 'delete\s+from\s+\w+\s*;?' && ! echo "$lower_content" | grep -q 'where'; then
              echo "âŒ $file contÃ©m DELETE sem WHERE"
              has_error=1
            fi

            # DROP alerta (nÃ£o falha)
            if echo "$lower_content" | grep -q 'drop '; then
              echo "âš ï¸ AtenÃ§Ã£o: DROP encontrado em $file"
            fi

            # Encoding UTF-8
            if ! file -bi "$file" | grep -q 'utf-8'; then
              echo "âŒ $file nÃ£o estÃ¡ em UTF-8"
              has_error=1
            fi
          done

          exit $has_error
